name: Deploy Infrastructure Only

on:
  workflow_dispatch:

env:
  TERRAFORM_VERSION: '1.5.0'
  PYTHON_VERSION: '3.11'
  TFLINT_VERSION: '0.51.1'
  TFSEC_VERSION: '1.28.1'
  TERRAFORM_DOCS_VERSION: '0.17.0'

jobs:
  pre-commit:
    name: 'Pre-commit Checks'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Install tflint, tfsec, terraform-docs
        run: |
          set -e
          curl -sL "https://github.com/terraform-linters/tflint/releases/download/v${{ env.TFLINT_VERSION }}/tflint_linux_amd64.zip" -o /tmp/tflint.zip
          unzip -o /tmp/tflint.zip -d /usr/local/bin
          chmod +x /usr/local/bin/tflint

          curl -sL "https://github.com/aquasecurity/tfsec/releases/download/v${{ env.TFSEC_VERSION }}/tfsec-linux-amd64" -o /usr/local/bin/tfsec
          chmod +x /usr/local/bin/tfsec

          curl -sL "https://github.com/terraform-docs/terraform-docs/releases/download/v${{ env.TERRAFORM_DOCS_VERSION }}/terraform-docs-v${{ env.TERRAFORM_DOCS_VERSION }}-linux-amd64.tar.gz" -o /tmp/terraform-docs.tar.gz
          tar -xzf /tmp/terraform-docs.tar.gz -C /usr/local/bin terraform-docs
          chmod +x /usr/local/bin/terraform-docs

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit
        run: pre-commit run --all-files

  terraform-plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    needs: pre-commit
    outputs:
      backend_key: terraform.tfstate
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Terraform Service Principal Environment Variables
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')" >> $GITHUB_ENV

      - name: Create Terraform Backend Infrastructure
        run: |
          RG_NAME="rg-terraform-state"
          STORAGE_NAME="tfstateemp"
          CONTAINER_NAME="tfstate"
          LOCATION="eastus"

          az group create --name "$RG_NAME" --location "$LOCATION" 2>/dev/null || true
          az storage account create --resource-group "$RG_NAME" --name "$STORAGE_NAME" --sku Standard_LRS --kind StorageV2 --https-only true 2>/dev/null || true
          az storage container create --account-name "$STORAGE_NAME" --name "$CONTAINER_NAME" 2>/dev/null || true

      - name: Terraform Init
        working-directory: .
        run: |
          terraform init \
            -backend-config="resource_group_name=rg-terraform-state" \
            -backend-config="storage_account_name=tfstateemp" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=terraform.tfstate"

      - name: Terraform Validate
        working-directory: .
        run: terraform validate

      - name: Terraform Format Check
        working-directory: .
        run: terraform fmt -recursive -check || true

      - name: Terraform Plan
        working-directory: .
        run: terraform plan -var-file="dev.tfvars" -out=tfplan

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan
          path: tfplan

  terraform-apply:
    name: 'Terraform Apply (approval required)'
    needs: terraform-plan
    runs-on: ubuntu-latest
    environment: tf-apply
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Terraform Service Principal Environment Variables
        run: |
          echo "ARM_CLIENT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientId')" >> $GITHUB_ENV
          echo "ARM_CLIENT_SECRET=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.clientSecret')" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.tenantId')" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=$(echo '${{ secrets.AZURE_CREDENTIALS }}' | jq -r '.subscriptionId')" >> $GITHUB_ENV

      - name: Download Plan Artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan
          path: .

      - name: Terraform Init
        working-directory: .
        run: |
          terraform init \
            -backend-config="resource_group_name=rg-terraform-state" \
            -backend-config="storage_account_name=tfstateemp" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=terraform.tfstate"

      - name: Terraform Apply
        working-directory: .
        run: terraform apply -auto-approve tfplan
